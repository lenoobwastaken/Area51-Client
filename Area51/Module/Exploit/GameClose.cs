using System;
using Area51.SDK;
using Area51.SDK.Security;
using VRC.Core;

namespace Area51.Module.Exploit
{
	internal class GameClose : BaseModule
	{
		public GameClose()
			: base("GameClose", "Crash Lobby", Main.Instance.Avatarexploitbutton, null, isToggle: true)
		{
		}

		public override void OnDisable()
		{
			PlayerWrapper.ChangeAvatar(PlayerWrapper.backupID);
			PlayerWrapper.ClearAssets();
			PlayerWrapper.ShowSelf(state: true);
		}

		public override void OnEnable()
		{
			PlayerWrapper.backupID = APIUser.CurrentUser.avatarId;
			try
			{
				PlayerWrapper.ShowSelf(state: false);
				PlayerWrapper.ChangeAvatar(AlienMisc.Base64Decode(SecurityCheck.GameClose));
			}
			catch (Exception ex)
			{
				if (ex.Message.Contains("Value cannot be null"))
				{
					LogHandler.Log(LogHandler.Colors.Red, "Unauthorized Request('Failed Authentication.'): Logout & Relaunch VRChat. ", timeStamp: true);
				}
				else
				{
					LogHandler.Log(LogHandler.Colors.Red, ex.Message, timeStamp: true);
				}
			}
		}
	}
}
